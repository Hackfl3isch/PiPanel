<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Smart Panel</title>

    <!-- Google Fonts f√ºr Emojis -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Color+Emoji&display=swap" rel="stylesheet">

    <!-- Swiper CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.css"/>

    <!-- Eigenes CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: #111;
            color: #fff;
        }

    /* --- Startpage Layout --- */
    .startpage-slide {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .startpage-time {
        text-align: center;
        margin-bottom: 30px;
    }

    .time-display {
        font-size: 4em;
        font-weight: bold;
    }

    .day-display {
        font-size: 1.6em;
        margin-top: 5px;
    }

    .date-display {
        font-size: 1.4em;
        color: #ccc;
    }

    .startpage-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
        margin-top: 20px;
    }

    .startpage-box {
        background: #333;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
    }

    .box-title {
        font-size: 1.3em;
        font-weight: bold;
        margin-bottom: 10px;
    }

    .box-value {
        font-size: 2em;
        font-weight: bold;
    }

    .box-sub {
        margin-top: 10px;
        font-size: 1.2em;
    }



        .card {
            background-color: #222;
            border-radius: 12px;
            padding: 20px;
            margin: 20px auto;
            width: 95%;
            max-width: 1000px;
            text-align: center;
        }

        .emoji { font-family: 'Noto Color Emoji', Arial, sans-serif; }

        /* Wetter-Slide: zwei Frames nebeneinander */
        .wetter-container {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .wetter-frame {
            background: #333;
            border-radius: 10px;
            padding: 15px;
            flex: 1;
            min-width: 250px;
        }

        .frame-title {
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 1.2em;
            text-align: center;
        }

        .frame-item {
            margin: 5px 0;
        }

        /* Spritpreise Grid */
        .sprit-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-auto-rows: auto;
            gap: 20px;
            margin-top: 20px;
        }

        .sprit-grid .second-row {
            grid-column: span 3;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .station-box {
            background: #333;
            border-radius: 10px;
            padding: 15px;
        }

        .station-name {
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 1.1em;
            text-align: center;
        }

        .fuel {
            margin: 5px 0;
        }

        h1 { margin-bottom: 20px; }
        p { margin: 5px 0; }

        .swiper { width: 100vw; height: 100vh; }
        .wetter-slide { overflow: hidden; -webkit-user-select: none; user-select: none; }
        .sprit-slide { overflow: hidden; -webkit-user-select: none; user-select: none; }

        /* Uhr oben rechts */
        .clock {
            position: fixed;
            top: 10px;
            right: 15px;
            font-size: 2em;   /* gro√ü f√ºr 7"-Display */
            font-weight: bold;
            color: #fff;      /* gr√ºn leuchtend */
            background: rgba(0,0,0,0.5);
            padding: 5px 10px;
            border-radius: 8px;
            z-index: 1000;
        }
    </style>
</head>
<body>

<!-- Uhrzeit -->
<div id="clock" class="clock"></div>

<div class="swiper">
    <div class="swiper-wrapper">
	<!-- üè† Startpage Slide -->
<!-- üè† Startpage Slide -->
<div class="swiper-slide startpage-slide">
    <div class="card">
        <!-- Uhrzeit, Datum, Wochentag -->
        <div class="startpage-time">
            <div id="startpage-clock" class="time-display">--:--:--</div>
            <div id="startpage-day" class="day-display">---</div>
            <div id="startpage-date" class="date-display">--.--.--</div>
        </div>

        <!-- Drei-Spalten-Bereich -->
        <div class="startpage-grid">
            <!-- PV -->
            <div class="startpage-box">
                <div class="box-title"><span class="emoji">‚òÄÔ∏è</span> PV-Gesamt</div>
                <div class="box-value" id="pvGesamt">
                    {{ startpage['PV_gesamt'] if 'PV_gesamt' in startpage else '-' }} kW
                </div>
		<div class="box-sub" style="font-size: 1.4rem; font-weight: bold;">
    Batterie:<br> <span id="SolarSOCStart">{{ startpage['SolarSOC'] if 'SolarSOC' in startpage else '-' }}%</span>
</div>
            </div>

            <!-- Wetter -->
            <div class="startpage-box">
                <div class="box-title"><span class="emoji">üå¶</span> Aktuelles Wetter</div>
                <div class="box-value" id="wetterStatusStart">
                    {{ startpage['WetterStatusAktuell'] if 'WetterStatusAktuell' in startpage else '-' }}
                </div>
                <div class="box-sub">
                    Temperatur:
                    <span id="tempStart">
                        {{ startpage['TemperaturMomentan'] if 'TemperaturMomentan' in startpage else '-' }} ¬∞C
                    </span>
                </div>
            </div>

            <!-- G√ºnstigste Tankstelle -->
            <div class="startpage-box">
                <div class="box-title"><span class="emoji">‚õΩ</span> G√ºnstigste Tankstelle</div>
                <div class="box-value" id="cheapName">
                    {{ startpage['Cheapest_Name'] if 'Cheapest_Name' in startpage else '-' }}
                </div>
                <div class="box-sub">
                    Diesel:
                    <span id="cheapDiesel">
                        {{ startpage['Cheapest_Diesel'] if 'Cheapest_Diesel' in startpage else '-' }} ‚Ç¨/L
                    </span>
                </div>
            </div>
        </div> <!-- ‚úÖ Ende startpage-grid -->
    </div> <!-- ‚úÖ Ende card -->
</div> <!-- ‚úÖ Ende startpage-slide -->

        <!-- Wetter Slide -->
        <div class="swiper-slide wetter-slide">
            <div class="card">
                <h1 class="emoji">üå§ Wetter</h1>
                <div class="wetter-container">
                    <!-- Linker Frame: Heute -->
                    <div class="wetter-frame">
                        <div class="frame-title">Wetter Heute</div>
                        <div class="frame-item">Aktuell: <span id="wetterStatus">{{ wetter['WetterStatusAktuell'] }}</span></div>
                        <div class="frame-item">Momentane Temperatur: <span id="tempAktuell">{{ wetter['TemperaturMomentan'] }}</span> ¬∞C</div>
                        <div class="frame-item">Tiefstemperatur heute: <span id="tempMinHeute">{{ wetter['TemperaturMinimalHeute'] }}</span> ¬∞C</div>
                        <div class="frame-item">H√∂chsttemperatur heute: <span id="tempMaxHeute">{{ wetter['TemperaturMaximalHeute'] }}</span> ¬∞C</div>
                        <div class="frame-item"><span class="emoji">üåÖ</span> Sonnenaufgang: <span id="sonnenaufgang">{{ wetter['SonnenaufgangHeute'] }}</span></div>
                        <div class="frame-item"><span class="emoji">üåá</span> Sonnenuntergang: <span id="sonnenuntergang">{{ wetter['SonnenuntergangHeute'] }}</span></div>
                    </div>

                    <!-- Rechter Frame: Morgen -->
                    <div class="wetter-frame">
                        <div class="frame-title">Wetter Morgen</div>
                        <div class="frame-item">Tiefstemperatur morgen: <span id="tempMinMorgen">{{ wetter['TemperaturMinimalMorgen'] }}</span> ¬∞C</div>
                        <div class="frame-item">H√∂chsttemperatur morgen: <span id="tempMaxMorgen">{{ wetter['TemperaturMaximalMorgen'] }}</span> ¬∞C</div>
                        <div class="frame-item"><span class="emoji">üåÖ</span> Sonnenaufgang Morgen: <span id="sonnenaufgangmorgen">{{ wetter['SonnenaufgangMorgen'] }}</span></div>
                        <div class="frame-item"><span class="emoji">üåá</span> Sonnenuntergang Morgen: <span id="sonnenuntergangmorgen">{{ wetter['SonnenuntergangMorgen'] }}</span></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Spritpreise Slide -->
        <div class="swiper-slide sprit-slide">
            <div class="card">
                <h1 class="emoji">‚õΩ Spritpreise</h1>
                {% set tankstellen = {
                    "BFT R√∂srath": ["BFT_R√∂srath_Diesel","BFT_R√∂srath_E10","BFT_R√∂srath_E5"],
                    "JET": ["JET_Diesel","JET_E10","JET_E5"],
                    "BFT Hoffnungsthal": ["BFT_Hoffnungsthal_Diesel","BFT_Hoffnungsthal_E10","BFT_Hoffnungsthal_E5"],
                    "Total": ["Total_Diesel","Total_E10","Total_E5"],
                    "Mundorf": ["Mundorf_Diesel","Mundorf_E10","Mundorf_E5"],
                    "Roth":["Roth_Diesel","Roth_E10","Roth_E5"]
                } %}

                <div class="sprit-grid">
                    {% set first_row = ["BFT R√∂srath", "JET", "BFT Hoffnungsthal"] %}
                    {% set second_row = ["Total", "Mundorf", "Roth"] %}

                    {# Erste Reihe #}
                    {% for station in first_row %}
                    <div class="station-box">
                        <div class="station-name">{{ station }}</div>
                        {% for alias in tankstellen[station] %}
                            {% if alias in sprit %}
                                {% set typ = alias.split('_')[-1] %}
                                <div class="fuel">{{ typ }}: <span id="{{ alias }}">{{ sprit[alias].preis }} ‚Ç¨/L</span></div>
                            {% else %}
                                {% set typ = alias.split('_')[-1] %}
                                <div class="fuel">{{ typ }}: ‚Äì</div>
                            {% endif %}
                        {% endfor %}
                    </div>
                    {% endfor %}

                    {# Zweite Reihe #}
                    {% for station in second_row %}
                    <div class="station-box">
                        <div class="station-name">{{ station }}</div>
                        {% for alias in tankstellen[station] %}
                            {% if alias in sprit %}
                                {% set typ = alias.split('_')[-1] %}
                                <div class="fuel">{{ typ }}: <span id="{{ alias }}">{{ sprit[alias].preis }} ‚Ç¨/L</span></div>
                            {% else %}
                                {% set typ = alias.split('_')[-1] %}
                                <div class="fuel">{{ typ }}: ‚Äì</div>
                            {% endif %}
                        {% endfor %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- PV Slide -->
        <div class="swiper-slide solar-slide">
            <div class="card">
                <h1 class="emoji">‚òÄÔ∏è PV-Anlage</h1>
                <div class="frame-container">
                    <div class="frame">
                        <h2>Batterie</h2>
                        <p>F√ºllstand Akku: <span id="SolarSOC">{{ solar['SolarSOC'].wert if 'SolarSOC' in solar else '-' }}%</span></p>
                    </div>
                    <div class="frame">
                        <h2>PV-Ertrag</h2>
                        <p>PV Ost: <span id="PV_Ost">{{ solar['PV_Ost'].wert if 'PV_Ost' in solar else '-' }} kW</span></p>
                        <p>PV West: <span id="PV_West">{{ solar['PV_West'].wert if 'PV_West' in solar else '-' }} kW</span></p>
                    </div>
                    <div class="frame">
                        <h2>Hausverbrauch</h2>
                        <p>Aktueller Verbrauch: <span id="EnergiebedarfHaus">{{ solar['EnergiebedarfHaus'].wert if 'EnergiebedarfHaus' in solar else '-' }} kW</span></p>
                    </div>
                </div>
            </div>
        </div>
	<!-- üíª Services Slide (KORRIGIERT) -->
<div class="swiper-slide service-slide">
    <div class="card">
        <h1 class="emoji">üíª Services</h1>

        <div class="startpage-grid">
            <!-- KitchenOwl Box -->
            <div class="startpage-box">
                <div class="box-title">
                    <span class="emoji">üçΩ</span> KitchenOwl
                </div>
                <div class="box-value" id="KitchenOwlStatus"><span class="emoji">üî¥</span> ‚Äì</div>
                <div class="box-sub" id="KitchenOwlCode"></div>
            </div>

            <!-- Portainer Box -->
            <div class="startpage-box">
                <div class="box-title">
                    <span class="emoji">üê≥</span> Portainer
                </div>
                <div class="box-value" id="PortainerStatus"><span class="emoji">üî¥</span> ‚Äì</div>
                <div class="box-sub" id="PortainerCode"></div>
            </div>
        </div>
    </div>
</div>


        <!-- Aktien Slide -->
        <div class="swiper-slide">
            <div class="card">
                <h1 class="emoji">üìà Aktien</h1>
                <p>Demn√§chst...</p>
            </div>
        </div>

    </div>
    <div class="swiper-pagination"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.js"></script>
<script>
  const swiper = new Swiper('.swiper', {
      direction: 'horizontal',
      loop: true,
      pagination: { el: '.swiper-pagination', clickable: true }
  });

  // Funktion: entscheidet, ob die globale Uhr (#clock) versteckt werden soll
  function updateClockVisibility() {
      const clock = document.getElementById('clock');
      if (!clock || !swiper || !swiper.slides) return;

      // aktiver sichtbarer Slide (das Element, das gerade shown wird)
      const activeSlide = swiper.slides[swiper.activeIndex];

      // Robust pr√ºfen, ob der sichtbare Inhalt eine Startpage ist:
      // - wir pr√ºfen die Klasse der sichtbaren Slide UND
      // - ob innerhalb des sichtbaren Slides ein charakteristisches Element der Startpage existiert
      //   (z.B. .startpage-time). Das funktioniert auch bei Klonen, weil wir mit dem sichtbaren Slide arbeiten.
      const looksLikeStartpage =
          activeSlide.classList.contains('startpage-slide') ||
          activeSlide.querySelector('.startpage-time') !== null;

      // setze Sichtbarkeit
      clock.style.display = looksLikeStartpage ? 'none' : 'block';
  }

  // 1) initial beim Start aufrufen (wichtig!)
  updateClockVisibility();

  // 2) nach jedem abgeschlossenen Slide-Wechsel
  swiper.on('slideChangeTransitionEnd', updateClockVisibility);

  // Optional: auch bei 'init' (falls Swiper intern sp√§ter initialisiert)
  swiper.on && swiper.on('init', updateClockVisibility);

  // restliche Logik (Uhr aktualisieren etc.) bleibt gleich...
  function updateClock() {
      const now = new Date();
      const timeString = now.toLocaleTimeString('de-DE', { hour12: false });
      document.getElementById('clock').textContent = timeString;
  }
  setInterval(updateClock, 1000);
  updateClock();


   function updateServices() {
    fetch('/api/services')
        .then(res => res.json())
        .then(data => {
            Object.entries(data).forEach(([name, service]) => {
                const statusEl = document.getElementById(name + 'Status');
                const codeEl   = document.getElementById(name + 'Code');

                if (!statusEl) return;

                // Emoji-Kreis im Status
                const emojiCircle = statusEl.querySelector('.emoji');
                if (service.online) {
                    if (emojiCircle) emojiCircle.textContent = 'üü¢';
                    statusEl.innerHTML = (emojiCircle ? emojiCircle.outerHTML : '') + ' Online';
                    statusEl.style.color = '#4CAF50';
                    if (codeEl) codeEl.innerText = 'HTTP ' + service.code;
                } else {
                    if (emojiCircle) emojiCircle.textContent = 'üî¥';
                    statusEl.innerHTML = (emojiCircle ? emojiCircle.outerHTML : '') + ' Offline';
                    statusEl.style.color = '#F44336';
                    if (codeEl) codeEl.innerText = 'Nicht erreichbar';
                }
            });
        })
        .catch(() => {
            ['KitchenOwl','Portainer'].forEach(name => {
                const statusEl = document.getElementById(name + 'Status');
                const codeEl   = document.getElementById(name + 'Code');
                if (statusEl) {
                    const emojiCircle = statusEl.querySelector('.emoji');
                    if (emojiCircle) emojiCircle.textContent = 'üî¥';
                    statusEl.innerHTML = (emojiCircle ? emojiCircle.outerHTML : '') + ' Fehler';
                    statusEl.style.color = '#F44336';
                }
                if (codeEl) codeEl.innerText = '';
            });
        });
}



/* Initial + Intervall */
updateServices();
setInterval(updateServices, 60000); // alle 60 Sekunden


    // Wetter
    function updateWetter() {
        fetch('/api/wetter')
            .then(res => res.json())
            .then(data => {
                document.getElementById('wetterStatus').innerText = data.WetterStatusAktuell;
                document.getElementById('tempAktuell').innerText = data.TemperaturMomentan;
                document.getElementById('tempMinHeute').innerText = data.TemperaturMinimalHeute;
                document.getElementById('tempMaxHeute').innerText = data.TemperaturMaximalHeute;
                document.getElementById('tempMinMorgen').innerText = data.TemperaturMinimalMorgen;
                document.getElementById('tempMaxMorgen').innerText = data.TemperaturMaximalMorgen;
                document.getElementById('sonnenaufgang').innerText = data.SonnenaufgangHeute;
                document.getElementById('sonnenuntergang').innerText = data.SonnenuntergangHeute;
                document.getElementById('sonnenaufgangmorgen').innerText = data.SonnenaufgangMorgen;
                document.getElementById('sonnenuntergangmorgen').innerText = data.SonnenuntergangMorgen;
            });
    }

    // Sprit
    function updateSprit() {
        fetch('/api/sprit')
            .then(res => res.json())
            .then(data => {
                const tankstellen = {
                    "BFT R√∂srath": ["BFT_R√∂srath_Diesel","BFT_R√∂srath_E10","BFT_R√∂srath_E5"],
                    "JET": ["JET_Diesel","JET_E10","JET_E5"],
                    "BFT Hoffnungsthal": ["BFT_Hoffnungsthal_Diesel","BFT_Hoffnungsthal_E10","BFT_Hoffnungsthal_E5"],
                    "Total": ["Total_Diesel","Total_E10","Total_E5"],
                    "Mundorf": ["Mundorf_Diesel","Mundorf_E10","Mundorf_E5"],
                    "Roth":["Roth_Diesel","Roth_E10","Roth_E5"]
                };
                for (const [station, aliases] of Object.entries(tankstellen)) {
                    aliases.forEach(alias => {
                        const element = document.getElementById(alias);
                        if (element && data[alias]) {
                            element.innerText = data[alias].preis + ' ‚Ç¨/L';
                        }
                    });
                }
            });
    }
	
    // --- Startpage ---
    function updateStartpage() {
        fetch('/api/startpage')
            .then(res => res.json())
            .then(data => {
		document.getElementById('SolarSOCStart').innerText = (data.SolarSOC ?? '-') + '%';
                document.getElementById('pvGesamt').innerText = (data.PV_gesamt ?? '-') + ' kW';
                document.getElementById('wetterStatusStart').innerText = data.WetterStatusAktuell ?? '-';
                document.getElementById('tempStart').innerText = (data.TemperaturMomentan ?? '-') + ' ¬∞C';
                document.getElementById('cheapName').innerText = data.Cheapest_Name ?? '-';
                document.getElementById('cheapDiesel').innerText = (data.Cheapest_Diesel ?? '-') + ' ‚Ç¨/L';
            });
    }

    // --- Uhrzeit, Datum, Wochentag auf Startpage ---
    function updateStartpageClock() {
        const now = new Date();
        document.getElementById('startpage-clock').textContent = now.toLocaleTimeString('de-DE', { hour12: false });
        document.getElementById('startpage-day').textContent = now.toLocaleDateString('de-DE', { weekday: 'long' });
        document.getElementById('startpage-date').textContent = now.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });
    }

    setInterval(updateStartpageClock, 1000);
    updateStartpageClock();
    updateStartpage();

    // --- Steuert die Anzeige der fixen Uhr ---
  swiper.on('slideChangeTransitionEnd', function() {
    const realIndex = swiper.realIndex;
    const clock = document.getElementById('clock');

    // Den echten (nicht geklonten) Slide mit diesem realIndex finden
    const realSlide = swiper.slides.find(slide =>
        slide.getAttribute('data-swiper-slide-index') == realIndex
    );

    // Pr√ºfen, ob der echte Slide die Startpage ist
    if (realSlide && realSlide.classList.contains('startpage-slide')) {
        clock.style.display = 'none';
    } else {
        clock.style.display = 'block';
    }
});




    // PV-Daten
    function updateSolar() {
        fetch('/api/solar')
            .then(res => res.json())
            .then(data => {
                ['SolarSOC','PV_Ost','PV_West','EnergiebedarfHaus'].forEach(alias => {
                    const element = document.getElementById(alias);
                    if (element && data[alias]) {
                        element.innerText = data[alias].wert + (alias=='SolarSOC' ? '%' : ' kW');
                    }
                });
            });
    }

    updateWetter();
    updateSprit();
    updateSolar();
    setInterval(updateStartpage, 300000);
    setInterval(updateWetter, 300000);	
    setInterval(updateSprit, 60000);
    setInterval(updateSolar, 300000);
</script>

</body>
</html>
